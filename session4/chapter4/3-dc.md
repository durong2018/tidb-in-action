## 4.3 两地三中心 
###1  部署架构
TiDB两地三中心架构基于Raft算法，保证集群数据一致性和高可用。两地是同城、异地，同城双中心指在同城或临近城市建立独立数据中心，双中心通过高速链路实时同步数据，网络延迟相对较小，另外一个数据中心在异地城市。在这种场景下，可以把业务流量同时派发到同城两个数据中心，通过控制Region leader和PD leader 也分布在同城两个数据中心。

####1.1 架构图
以北京和西安为例阐述TiDB两地三中心架构部署模型，这里采用北京两个机房IDC1和IDC2，异地西安一个机房IDC3。北京与西安之间延迟低于3ms，北京与西安之间使用ISP专线，延迟约20ms。
如图下1所示为集群部署架构图，具体如下：
1）部署采用主从架构，主集群作为生产集群，承担日常生产服务，从集群同通过binlog异步同步主集群数据库，作为备份数据库使用。
2）生产集群采用两地三中心，分别为北京IDC1，北京IDC2，西安IDC3；
3）生产集群采用5副本模式，其中IDC和IDC2分别放2个副本，IDC3放1个副本；TiKV按机柜打Label，既每个机柜上有一份副本。
4）从集群与主集群直接通过binlog同步采用消息缓存服务器Kafka完成中间数据存储与传输工作。
![Alt text](./架构图.png)


图 1  两地三中心集群架构图 

该架构具备高可用和容灾备份能力。相比于三数据中心方案优势如下：
1）写入速度更优。
2）两中心同时提供服务资源利用率更高。
3）可保证任一数据中心失效后，服务可用并且不发生数据丢失。
缺点很明显，因TiDB两地三中心基于Raft算法，同城两个数据中心同时失效，只有一个节点存在，不满足Raft算法大多数节点存在要求，最终将导致集群不可用及部分数据丢失，而且这种情况发生概率高于异地三数据中心损失概率；另外该架构成本较高。 

####1.2 部署说明
下面具体介绍两地三中心架构部署详情。

![Alt text](./配置详情.png)

图2  两地三中心配置详图

北京、西安两地三中心配置详解：
1）如图2所示，北京有两个机房IDC1和IDC2，机房IDC1中有三套机架RAC1、RAC2、RAC3，机房IDC2有机架RAC4、RAC5；西安机房IDC3有机架RAC6、RAC7，其中机架RAC7上有从集群用于备份的服务器。
2）如图中RAC1机架所示，TiDB、PD服务部署在同一台服务器上，还有两台TiKV服务器；每台TiKV服务器部署2个TiDB实例，即TiKV服务器上每块PCIe SSD上单独部署一个TiKV实例；RAC2、RAC4、RAC5、RAC6类似。
3）机架RAC3上安放TiDB-Server及中控+监控服务器。部署TiDB-Server，用于日常管理维护、备份使用。中控+监控服务器上部署TiDB-Ansible、Prometheus，Grafana以及恢复工具；
4）从集群配置较高，采用混合部署方式，每台服务器上部署2个TiKV实例，其中的3台部署TiDB及PD。
5）备份服务器上部署Mydumper及Dranier以PB模式输出为增量备份文件。

